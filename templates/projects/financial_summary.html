{% extends 'base.html' %}
{% load static %}

{% block title %}Resumen Financiero - {{ project.name }}{% endblock %}

{% block content %}
<style>
    .financial-card {
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }
    .financial-card:hover {
        transform: translateY(-5px);
    }
    .traffic-green { background: linear-gradient(135deg, #28a745, #20c997); color: white; }
    .traffic-yellow { background: linear-gradient(135deg, #ffc107, #fd7e14); color: #333; }
    .traffic-red { background: linear-gradient(135deg, #dc3545, #c82333); color: white; }
    .traffic-gray { background: linear-gradient(135deg, #6c757d, #495057); color: white; }
    .progress-thin {
        height: 8px;
        border-radius: 4px;
    }
</style>

<div class="container-fluid my-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-primary mb-1">üí∞ Resumen Financiero</h2>
            <p class="text-muted mb-0">{{ project.name }}</p>
        </div>
        <div>
            <a href="{% url 'project_detail' project.pk %}" class="btn btn-outline-secondary rounded-pill me-2">
                ‚¨ÖÔ∏è Volver al Proyecto
            </a>
            <a href="{% url 'dashboard' %}" class="btn btn-secondary rounded-pill">
                üè† Dashboard
            </a>
        </div>
    </div>

    <!-- Traffic Light Status -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="financial-card p-4 traffic-{{ traffic_light }}">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-1">Estado del Proyecto</h4>
                        <p class="mb-0">
                            {% if traffic_light == 'green' %}
                                üü¢ En Tiempo y Presupuesto - El proyecto marcha seg√∫n lo planificado
                            {% elif traffic_light == 'yellow' %}
                                üü° Atenci√≥n Requerida - Existen desviaciones menores
                            {% elif traffic_light == 'red' %}
                                üî¥ Cr√≠tico - Requiere intervenci√≥n inmediata
                            {% else %}
                                ‚ö™ Sin Datos - No hay suficiente informaci√≥n
                            {% endif %}
                        </p>
                    </div>
                    <div class="text-end">
                        <h2 class="mb-0">{{ utilization|floatformat:1 }}%</h2>
                        <small>Utilizaci√≥n del Presupuesto</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Financial Summary Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="financial-card bg-white p-4">
                <div class="text-muted small text-uppercase mb-2">Presupuesto Total</div>
                <h3 class="text-primary mb-0">${{ budget|floatformat:2|default:"0.00" }}</h3>
            </div>
        </div>
        <div class="col-md-3">
            <div class="financial-card bg-white p-4">
                <div class="text-muted small text-uppercase mb-2">Costo Actividades</div>
                <h3 class="text-info mb-0">${{ activities_cost|floatformat:2 }}</h3>
            </div>
        </div>
        <div class="col-md-3">
            <div class="financial-card bg-white p-4">
                <div class="text-muted small text-uppercase mb-2">Costo Recursos</div>
                <h3 class="text-warning mb-0">${{ resources_cost|floatformat:2 }}</h3>
            </div>
        </div>
        <div class="col-md-3">
            <div class="financial-card bg-white p-4">
                <div class="text-muted small text-uppercase mb-2">Costo Total Real</div>
                <h3 class="text-danger mb-0">${{ total_cost|floatformat:2 }}</h3>
            </div>
        </div>
    </div>

    <!-- Budget Variance -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="financial-card bg-white p-4">
                <h5 class="mb-3">üìä Variaci√≥n Presupuestaria</h5>
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="progress progress-thin" style="height: 20px;">
                            {% widthratio utilization 1 100 as util_width %}
                            <div class="progress-bar {% if utilization > 100 %}bg-danger{% elif utilization > 80 %}bg-warning{% else %}bg-success{% endif %}" 
                                 style="width: {% if utilization > 100 %}100{% else %}{{ utilization }}{% endif %}%;">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        {% if variance %}
                            {% if variance > 0 %}
                                <span class="text-success fw-bold">+${{ variance|floatformat:2 }}</span>
                                <br><small class="text-muted">Bajo presupuesto</small>
                            {% else %}
                                <span class="text-danger fw-bold">${{ variance|floatformat:2 }}</span>
                                <br><small class="text-muted">Sobre presupuesto</small>
                            {% endif %}
                        {% else %}
                            <span class="text-muted">Sin presupuesto definido</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Activities Cost Breakdown -->
    <div class="row">
        <div class="col-12">
            <div class="financial-card bg-white p-4">
                <h5 class="mb-4">üìã Desglose de Costos por Actividad</h5>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Actividad</th>
                                <th>Estado</th>
                                <th>Fecha Inicio</th>
                                <th>Fecha Fin</th>
                                <th class="text-end">Costo</th>
                                <th>Predecesora</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for activity in activities %}
                            <tr>
                                <td>
                                    <span class="fw-bold">{{ activity.name }}</span>
                                    {% if activity.description %}
                                        <br><small class="text-muted">{{ activity.description|truncatechars:50 }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if activity.status == 'completed' %}
                                        <span class="badge bg-success">Completada</span>
                                    {% elif activity.status == 'in_progress' %}
                                        <span class="badge bg-warning text-dark">En Progreso</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Pendiente</span>
                                    {% endif %}
                                </td>
                                <td>{{ activity.start_date|date:"d/m/Y" }}</td>
                                <td>{{ activity.end_date|date:"d/m/Y" }}</td>
                                <td class="text-end">${{ activity.cost|default:0|floatformat:2 }}</td>
                                <td>
                                    {% if activity.predecessor %}
                                        <span class="badge bg-info">{{ activity.predecessor.name }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center text-muted py-4">
                                    No hay actividades registradas para este proyecto.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-light">
                            <tr class="fw-bold">
                                <td colspan="4">Total Actividades</td>
                                <td class="text-end">${{ activities_cost|floatformat:2 }}</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
