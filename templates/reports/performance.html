{% extends 'base.html' %}
{% load static %}

{% block content %}
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>

<div class="container-fluid my-5 px-4">
    <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
        <div class="p-4 text-white" style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="fw-bold mb-1"><i class="fas fa-chart-line me-2"></i>Análisis de Valor Ganado (EVM)</h2>
                    <p class="mb-0 opacity-75">Rendimiento actual del proyecto: <strong>{{ proyecto.name }}</strong></p>
                </div>
                <a href="{% url 'reports:report_list' %}" class="btn btn-light btn-sm rounded-pill px-4 fw-bold text-primary shadow-sm">
                    <i class="fas fa-arrow-left me-1"></i> Volver a Reportes
                </a>
            </div>
        </div>

        <div class="card-body p-4 bg-light">
            {% if seguimientos %}
            <div class="row g-4">
                <div class="col-lg-8">
                    <div class="card border-0 shadow-sm rounded-4 p-3 bg-white h-100">
                        <div id="performance_chart" style="width:100%; height: 500px;"></div>
                    </div>
                </div>
                
                <div class="col-lg-4">
                    <div class="d-flex flex-column h-100 gap-4">
                        <h5 class="text-secondary fw-bold mb-0">Indicadores Clave (KPI)</h5>
                        
                        <div class="card border-0 shadow-sm rounded-4 text-center p-4 bg-white border-bottom border-4 border-primary">
                            <h6 class="text-uppercase text-muted small fw-bold">Índice de Desempeño del Plazo (SPI)</h6>
                            <h1 class="display-3 fw-bold my-2" id="spi_val">--</h1>
                            <div id="spi_badge" class="badge rounded-pill fs-6 py-2 px-3">Calculando...</div>
                            <p class="small text-muted mt-2 mb-0">Progreso vs. Planificación</p>
                        </div>

                        <div class="card border-0 shadow-sm rounded-4 text-center p-4 bg-white border-bottom border-4 border-success">
                            <h6 class="text-uppercase text-muted small fw-bold">Índice de Desempeño de Costos (CPI)</h6>
                            <h1 class="display-3 fw-bold my-2" id="cpi_val">--</h1>
                            <div id="cpi_badge" class="badge rounded-pill fs-6 py-2 px-3">Calculando...</div>
                            <p class="small text-muted mt-2 mb-0">Progreso vs. Gasto Real</p>
                        </div>
                        
                        <div class="mt-auto alert alert-info border-0 shadow-sm rounded-3 mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            <small>Valores <strong> > 1.0 </strong> indican que el proyecto está adelantado o bajo presupuesto.</small>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="text-center py-5">
                <div class="mb-3"><i class="fas fa-folder-open fa-4x text-muted opacity-25"></i></div>
                <h4 class="text-muted">No hay datos de seguimiento para este proyecto</h4>
                <p class="text-secondary">Debes registrar al menos un seguimiento para generar las gráficas de rendimiento.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    {% if seguimientos %}
    // Datos procesados desde el backend
    // Usamos el filtro 'safe' y floats para evitar errores de JS
    const labels = [{% for s in seguimientos %}'{{ s.fecha|date:"d M" }}'{% if not forloop.last %}, {% endif %}{% endfor %}];
    const dataPV = [{% for s in seguimientos %}{{ s.pv|default:0 }}{% if not forloop.last %}, {% endif %}{% endfor %}];
    const dataEV = [{% for s in seguimientos %}{{ s.ev|default:0 }}{% if not forloop.last %}, {% endif %}{% endfor %}];
    const dataAC = [{% for s in seguimientos %}{{ s.ac|default:0 }}{% if not forloop.last %}, {% endif %}{% endfor %}];

    // Lógica para indicadores KPI (basada en el último dato registrado)
    const lastEV = dataEV[dataEV.length - 1];
    const lastPV = dataPV[dataPV.length - 1];
    const lastAC = dataAC[dataAC.length - 1];

    const spi = lastPV > 0 ? (lastEV / lastPV).toFixed(2) : "1.00";
    const cpi = lastAC > 0 ? (lastEV / lastAC).toFixed(2) : "1.00";

    // Actualizar SPI
    const spiEl = document.getElementById('spi_val');
    const spiBadge = document.getElementById('spi_badge');
    spiEl.innerText = spi;
    spiEl.className = `display-3 fw-bold my-2 ${spi >= 1 ? 'text-primary' : 'text-danger'}`;
    spiBadge.innerText = spi >= 1 ? "A TIEMPO" : "RETRASADO";
    spiBadge.classList.add(spi >= 1 ? "bg-success" : "bg-danger");

    // Actualizar CPI
    const cpiEl = document.getElementById('cpi_val');
    const cpiBadge = document.getElementById('cpi_badge');
    cpiEl.innerText = cpi;
    cpiEl.className = `display-3 fw-bold my-2 ${cpi >= 1 ? 'text-success' : 'text-danger'}`;
    cpiBadge.innerText = cpi >= 1 ? "BAJO PRESUPUESTO" : "SOBRE COSTO";
    cpiBadge.classList.add(cpi >= 1 ? "bg-success" : "bg-danger");

    // Configuración del Gráfico de Highcharts
    Highcharts.chart('performance_chart', {
        chart: { 
            type: 'areaspline', 
            style: { fontFamily: 'inherit' }
        },
        title: { text: 'Gráfico de Desempeño Acumulado', align: 'left' },
        subtitle: { text: 'Comparativa de PV, EV y AC', align: 'left' },
        xAxis: { 
            categories: labels,
            crosshair: true
        },
        yAxis: { 
            title: { text: 'Valor Monetario ($)' },
            labels: { format: '${value}' }
        },
        tooltip: { 
            shared: true, 
            valuePrefix: '$',
            borderRadius: 10
        },
        plotOptions: {
            areaspline: { fillOpacity: 0.1 }
        },
        series: [{
            name: 'Valor Planificado (PV)',
            data: dataPV,
            color: '#0d6efd',
            dashStyle: 'shortdash'
        }, {
            name: 'Valor Ganado (EV)',
            data: dataEV,
            color: '#198754',
            lineWidth: 4,
            marker: { radius: 6 }
        }, {
            name: 'Costo Real (AC)',
            data: dataAC,
            color: '#dc3545'
        }],
        responsive: {
            rules: [{
                condition: { maxWidth: 500 },
                chartOptions: { legend: { layout: 'horizontal', align: 'center', verticalAlign: 'bottom' } }
            }]
        },
        credits: { enabled: false }
    });
    {% endif %}
});
</script>
{% endblock %}